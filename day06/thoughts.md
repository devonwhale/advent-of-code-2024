Clearly something I'm missing in part 2. Works fine with the test case but there's something not adding up in the actual data. If I get a chance I'll have a go at re-writing in a cleaner way and properly debugging it.